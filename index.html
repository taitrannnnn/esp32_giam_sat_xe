<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giám sát 3 xe — Realtime Firebase</title>

  <!-- TailwindCSS (CDN) cho giao diện nhanh, hiện đại -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (bản đồ, không cần API key) -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    #map { height: 420px; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="px-4 sm:px-8 py-5 border-b border-slate-800 sticky top-0 bg-slate-950/80 backdrop-blur">
    <h1 class="text-2xl sm:text-3xl font-semibold">Giám sát đội xe (3 xe) — Cập nhật realtime từ Firebase</h1>
    <p class="text-slate-400 mt-1">Thông số: Tốc độ (km/h), Vòng tua (RPM), Nhiên liệu (%), GPS.</p>
  </header>

  <main class="px-4 sm:px-8 py-6 space-y-6">
    <!-- Cards thông số cho 3 xe -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Mẫu card, nhân 3 -->
      <article id="car1-card" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Xe 1</h2>
          <span id="car1-updated" class="text-xs text-slate-400">—</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-slate-400">Tốc độ</span><strong id="car1-speed">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Vòng tua</span><strong id="car1-rpm">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Nhiên liệu</span><strong id="car1-fuel">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">GPS</span><strong id="car1-gps">—</strong></div>
        </div>
      </article>

      <article id="car2-card" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Xe 2</h2>
          <span id="car2-updated" class="text-xs text-slate-400">—</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-slate-400">Tốc độ</span><strong id="car2-speed">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Vòng tua</span><strong id="car2-rpm">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Nhiên liệu</span><strong id="car2-fuel">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">GPS</span><strong id="car2-gps">—</strong></div>
        </div>
      </article>

      <article id="car3-card" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Xe 3</h2>
          <span id="car3-updated" class="text-xs text-slate-400">—</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-slate-400">Tốc độ</span><strong id="car3-speed">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Vòng tua</span><strong id="car3-rpm">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">Nhiên liệu</span><strong id="car3-fuel">—</strong></div>
          <div class="flex justify-between"><span class="text-slate-400">GPS</span><strong id="car3-gps">—</strong></div>
        </div>
      </article>
    </section>

    <!-- Bản đồ vị trí 3 xe -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-3 shadow-lg">
      <div class="flex items-center justify-between px-1 pb-2">
        <h3 class="text-lg font-semibold">Bản đồ GPS (Leaflet + OpenStreetMap)</h3>
        <div class="text-xs text-slate-400">kéo/thu phóng để xem khu vực</div>
      </div>
      <div id="map" class="rounded-xl"></div>
    </section>
  </main>

  <!-- Firebase v10 (ESM, Realtime Database) -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsA0_xFCmVEU5AgjKZDh50WhTe_06Bfgk",
    authDomain: "esp32-606ff.firebaseapp.com",
    databaseURL: "https://esp32-606ff-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "esp32-606ff",
    storageBucket: "esp32-606ff.firebasestorage.app",
    messagingSenderId: "884972816677",
    appId: "1:884972816677:web:594fe5876f9acb8ea3f2cc",
    measurementId: "G-ZSH8JDZ35J"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM (Xe 1)
  const speedEl = document.getElementById("car1-speed");
  const rpmEl   = document.getElementById("car1-rpm");
  const fuelEl  = document.getElementById("car1-fuel");
  const gpsEl   = document.getElementById("car1-gps");
  const updEl   = document.getElementById("car1-updated");

  function fmt(val, unit="") {
    if (val === undefined || val === null || Number.isNaN(val)) return "—";
    return `${val}${unit}`;
  }

  // Lắng nghe đúng node ESP32 ghi
  const latestRef = ref(db, "obd/latest");
  onValue(latestRef, (snap) => {
    const d = snap.val();
    console.log("obd/latest =", d);   // <<< cực quan trọng để debug
    if (!d) {
      updEl.textContent = "No data";
      return;
    }
    speedEl.textContent = fmt(d.speed, " km/h");
    rpmEl.textContent   = fmt(d.rpm, " RPM");
    fuelEl.textContent  = fmt(d.coolant, " °C"); // tạm dùng ô nhiên liệu hiển thị coolant
    gpsEl.textContent   = "—";
    updEl.textContent   = d.ms ? `${d.ms} ms` : "—";
  }, (err) => {
    console.error("Firebase onValue error:", err);
    updEl.textContent = "Firebase error";
  });
</script>


  <!-- Gợi ý cấu trúc dữ liệu (tham khảo)
  {
    "vehicles": {
      "car1": {
        "speed_kph": 52,
        "rpm": 1800,
        "fuel_percent": 64,
        "gps": { "lat": 10.7769, "lng": 106.7009 },
        "lastUpdated": 1733576400000
      },
      "car2": { ... },
      "car3": { ... }
    }
  }
  -->

  <!-- Lưu ý bảo mật:
    - Thiết lập Realtime Database Rules phù hợp (chỉ đọc/ghi cho người dùng được phép).
    - Không để API key nhạy cảm bên client nếu dùng các dịch vụ khác.
  -->
</body>
</html>




